name: Security CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.12'

jobs:
  # Dependency Vulnerability Scanning
  dependency-scan:
    name: 'Dependency Vulnerability Scan'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Snyk frontend scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=frontend/package.json --package-manager=npm

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          cd banking_backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Snyk backend scan
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=banking_backend/requirements.txt

      - name: Run safety check (Python)
        run: |
          cd banking_backend
          pip install safety
          safety check --file requirements.txt --output json > safety-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-reports
          path: |
            banking_backend/safety-report.json

  # Static Application Security Testing (SAST)
  sast:
    name: 'Static Application Security Testing'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit (Python SAST)
        run: pip install bandit[toml]

      - name: Run Bandit on backend
        run: |
          cd banking_backend
          bandit -r . -f json -o bandit-report.json || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install ESLint and security plugins
        run: |
          cd frontend
          npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-security eslint-plugin-react-security

      - name: Run ESLint security scan
        run: |
          cd frontend
          npx eslint src/ --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-security-report.json || true

      - name: Upload SAST reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            banking_backend/bandit-report.json
            frontend/eslint-security-report.json

  # Dynamic Application Security Testing (DAST)
  dast:
    name: 'Dynamic Application Security Testing'
    runs-on: ubuntu-latest
    needs: [build-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OWASP ZAP
        run: |
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz
          tar -xzf ZAP_2.14.0_Linux.tar.gz
          echo "ZAP_PATH=$PWD/ZAP_2.14.0" >> $GITHUB_ENV

      - name: Start test application
        run: |
          docker-compose up -d
          sleep 30

      - name: Run OWASP ZAP baseline scan
        run: |
          export PATH=$PATH:$ZAP_PATH
          zap.sh -cmd -autorun $PWD/zap-baseline.yaml || true

      - name: Generate ZAP report
        run: |
          export PATH=$PATH:$ZAP_PATH
          zap.sh -cmd -autorun $PWD/zap-report.yaml || true

      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: |
            zap-report.html
            zap-report.xml

  # Compliance and Security Checks
  compliance-check:
    name: 'Compliance & Security Checks'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          # Check for common secret patterns
          if grep -r "password\|secret\|key\|token" --include="*.py" --include="*.js" --include="*.ts" --include="*.json" banking_backend/ frontend/ | grep -v "test\|example\|template\|node_modules" | grep -v "password.*hash\|password.*encrypt"; then
            echo "Potential hardcoded secrets found!"
            exit 1
          fi

      - name: OWASP Top 10 Compliance Check
        run: |
          # Check for common OWASP Top 10 issues
          echo "Checking for OWASP Top 10 compliance..."

          # A01:2021 - Broken Access Control
          if ! grep -r "permission_classes\|IsAuthenticated\|IsAdminUser" banking_backend/; then
            echo "Warning: Limited authentication/authorization checks found"
          fi

          # A02:2021 - Cryptographic Failures
          if grep -r " Fernet\|cryptography" banking_backend/; then
            echo "✓ Encryption libraries found"
          else
            echo "Warning: No encryption libraries detected"
          fi

          # A03:2021 - Injection
          if grep -r "select_for_update\|atomic\|transaction" banking_backend/; then
            echo "✓ Database transaction protections found"
          fi

      - name: Security Headers Check
        run: |
          # Check for security headers in nginx config
          if grep -q "X-Frame-Options\|X-Content-Type-Options\|X-XSS-Protection" nginx.conf; then
            echo "✓ Security headers configured"
          else
            echo "Warning: Security headers not found in nginx config"
          fi

  # Build and Test
  build-test:
    name: 'Build & Test'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm run test -- --coverage --watchAll=false

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          cd banking_backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests
        run: |
          cd banking_backend
          python manage.py test --verbosity=2

      - name: Build backend Docker image
        run: |
          cd banking_backend
          docker build -t banking-backend:test -f Dockerfile.prod .

  # Security Gates
  security-gates:
    name: 'Security Gates'
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast, dast, compliance-check]
    if: always()
    steps:
      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Check security gate conditions
        run: |
          # Define security thresholds
          HIGH_VULN_THRESHOLD=0
          MEDIUM_VULN_THRESHOLD=5

          # Check if any job failed
          if [[ "${{ needs.dependency-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.sast.result }}" == "failure" ]] || \
             [[ "${{ needs.dast.result }}" == "failure" ]] || \
             [[ "${{ needs.compliance-check.result }}" == "failure" ]]; then
            echo "Security checks failed!"
            exit 1
          fi

          echo "All security gates passed!"

      - name: Create security summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- SAST: ${{ needs.sast.result }}" >> security-summary.md
          echo "- DAST: ${{ needs.dast.result }}" >> security-summary.md
          echo "- Compliance: ${{ needs.compliance-check.result }}" >> security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

  # Deploy (only on main branch and all security checks passed)
  deploy:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    needs: [security-gates, build-test]
    if: github.ref == 'refs/heads/main' && needs.security-gates.result == 'success'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: banking-backend
        run: |
          # Build and push backend
          cd banking_backend
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }} -f Dockerfile.prod .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}

          # Build and push frontend
          cd ../frontend
          docker build -t $ECR_REGISTRY/banking-frontend:${{ github.sha }} -f Dockerfile.prod .
          docker push $ECR_REGISTRY/banking-frontend:${{ github.sha }}

      - name: Deploy to ECS
        run: |
          # Update ECS service with new image
          aws ecs update-service \
            --cluster banking-cluster \
            --service banking-service \
            --force-new-deployment \
            --query 'service.deployments[0].id'

      - name: Run database migrations
        run: |
          # Run migrations via ECS task
          aws ecs run-task \
            --cluster banking-cluster \
            --task-definition banking-backend \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[subnet-xxxxx],securityGroups=[sg-xxxxx]}" \
            --overrides '{"containerOverrides":[{"name":"banking-backend","command":["python","manage.py","migrate"]}]}'

      - name: Health check
        run: |
          # Wait for deployment and check health
          sleep 60
          curl -f https://your-app-domain.com/health/ || exit 1