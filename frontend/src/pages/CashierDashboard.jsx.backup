import React, { useState, useEffect } from 'react';
import TransactionForm from '../components/TransactionForm';
import { useAuth } from '../context/AuthContext';
import { formatCurrencyGHS } from '../utils/formatters';
import { api } from '../services/api.ts';
import { useNavigate } from 'react-router-dom';

function CashierDashboard() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('deposit');
  const [depositAmount, setDepositAmount] = useState('');
  const [withdrawalAmount, setWithdrawalAmount] = useState('');
  const [depositMemberId, setDepositMemberId] = useState('');
  const [withdrawalMemberId, setWithdrawalMemberId] = useState('');
  const [accountType, setAccountType] = useState('Savings');
  const [members, setMembers] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState({ type: '', text: '' });

  const tabs = [
    { id: 'deposit', name: 'Deposit', icon: '📥', color: 'var(--md-sys-color-secondary)' },
    { id: 'withdrawal', name: 'Withdrawal', icon: '📤', color: 'var(--md-sys-color-error)' }
  ];

  const dailySummary = {
    transactions: 45,
    totalAmount: formatCurrencyGHS(125670),
    cashOnHand: formatCurrencyGHS(5000),
    pendingApprovals: 3
  };

  useEffect(() => {
    fetchMembers();
    fetchTransactions();
  }, []);

  const fetchMembers = async () => {
    try {
      const response = await api.get('users/members/');
      setMembers(response.data || []);
    } catch (error) {
      console.error('Error fetching members:', error);
      setMembers([
        { id: '1', name: 'Kwame Asare', email: 'kwame@example.com' },
        { id: '2', name: 'Abena Mensah', email: 'abena@example.com' },
        { id: '3', name: 'Kofi Appiah', email: 'kofi@example.com' },
        { id: '4', name: 'Ama Osei', email: 'ama@example.com' }
      ]);
    }
  };

  const fetchTransactions = async () => {
    try {
      const response = await api.get('transactions/');
      const data = response.data;
      console.log('Full transactions response:', data);
      console.log('Response keys:', Object.keys(data));

      // Check common patterns for array data in objects
      if (data && typeof data === 'object') {
        console.log('data.results:', data.results);
        console.log('data.transactions:', data.transactions);
        console.log('data.data:', data.data);
        console.log('data.items:', data.items);
      }

      let transactionsArray = [];

      // Handle different possible response structures
      if (Array.isArray(data)) {
        // Case 1: Direct array response
        transactionsArray = data;
      } else if (data && typeof data === 'object') {
        // Case 2: Object with nested array
        if (Array.isArray(data.results)) {
          // Django REST framework pagination style
          transactionsArray = data.results;
          console.log('Using paginated results:', transactionsArray.length, 'transactions');
        } else if (Array.isArray(data.transactions)) {
          // Custom transactions key
          transactionsArray = data.transactions;
          console.log('Using transactions array:', transactionsArray.length, 'transactions');
        } else if (Array.isArray(data.data)) {
          // Common data key
          transactionsArray = data.data;
          console.log('Using data array:', transactionsArray.length, 'transactions');
        } else if (Array.isArray(data.items)) {
          // Another common pattern
          transactionsArray = data.items;
          console.log('Using items array:', transactionsArray.length, 'transactions');
        } else {
          // If no array found, check if we can use object values
          const values = Object.values(data);
          if (values.length > 0 && Array.isArray(values[0])) {
            transactionsArray = values[0];
            console.log('Using first array value:', transactionsArray.length, 'transactions');
          } else {
            console.warn('No array found in response object. Available keys:', Object.keys(data));
            transactionsArray = [];
          }
        }
      } else {
        console.warn('Unexpected response type:', typeof data);
        transactionsArray = [];
      }

      console.log('Final transactions array:', transactionsArray);
      setTransactions(transactionsArray);

    } catch (error) {
      console.error('Error fetching transactions:', error);
      setTransactions([]);
    }
  };

  const showMessage = (type, text) => {
    setMessage({ type, text });
    setTimeout(() => setMessage({ type: '', text: '' }), 5000);
  };

  const handleTransactionSubmit = async (e, type) => {
    e.preventDefault();
    
    const memberId = type === 'Deposit' ? depositMemberId : withdrawalMemberId;
    const amount = type === 'Deposit' ? depositAmount : withdrawalAmount;

    if (!memberId) {
      showMessage('error', 'Please select a member');
      return;
    }

    if (!amount || parseFloat(amount) <= 0) {
      showMessage('error', 'Please enter a valid amount');
      return;
    }

    setLoading(true);
    
    try {
      const response = await api.post('transactions/process/', {
        member_id: memberId,
        amount: parseFloat(amount),
        type: type,
        account_type: accountType
      });

      showMessage('success', `${type} of ${formatCurrencyGHS(amount)} for ${members.find(m => m.id === memberId)?.name} to ${accountType} account processed successfully! Receipt ID: ${response.data.receipt_id}`);
      
      if (type === 'Deposit') {
        setDepositAmount('');
        setDepositMemberId('');
      } else {
        setWithdrawalAmount('');
        setWithdrawalMemberId('');
      }
      
      await fetchTransactions();
      
    } catch (error) {
      const errorMessage = error.response?.data?.error || error.message || `${type} failed`;
      showMessage('error', `Error: ${errorMessage}`);
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = async () => {
    await logout();
    navigate('/login');
  };

  return (
    <div style={{ 
      minHeight: '100vh',
      background: 'var(--md-sys-color-background)',
      padding: '16px'
    }}>
      {/* App Bar */}
      <header className="md-elevated-card md-animate-slide-in-down" style={{
        marginBottom: '24px',
        padding: '20px 24px'
      }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px', marginBottom: '24px' }}>
          <div>
            <h1 className="md-typescale-headline-medium" style={{
              color: 'var(--md-sys-color-on-surface)',
              marginBottom: '4px'
            }}>
              Teller Operations
            </h1>
            <p className="md-typescale-body-medium" style={{
              color: 'var(--md-sys-color-on-surface-variant)'
            }}>
              Welcome, {user?.name} • Process transactions efficiently
            </p>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
            <div className="md-chip" style={{
              background: 'var(--md-sys-color-tertiary-container)',
              color: 'var(--md-sys-color-on-tertiary-container)',
              border: 'none'
            }}>
              💵 CASHIER
            </div>
            <button
              onClick={handleLogout}
              className="md-filled-button md-ripple"
              style={{
                background: 'var(--md-sys-color-error)',
                color: 'var(--md-sys-color-on-error)'
              }}
            >
              Logout
            </button>
          </div>
        </div>

        {/* Daily Summary Cards */}
        <div style={{ 
          display: 'grid', 
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
          gap: '12px' 
        }}>
          {[
            { label: 'Transactions Today', value: dailySummary.transactions, icon: '📊', color: 'primary' },
            { label: 'Total Amount', value: dailySummary.totalAmount, icon: '💰', color: 'secondary' },
            { label: 'Cash on Hand', value: dailySummary.cashOnHand, icon: '💵', color: 'tertiary' },
            { label: 'Pending Approvals', value: dailySummary.pendingApprovals, icon: '⏳', color: 'error' }
          ].map((stat, index) => (
            <div key={index} className="md-filled-card" style={{
              padding: '16px',
              display: 'flex',
              alignItems: 'center',
              gap: '12px'
            }}>
              <div style={{
                width: '40px',
                height: '40px',
                borderRadius: 'var(--md-sys-shape-corner-medium)',
                background: `var(--md-sys-color-${stat.color}-container)`,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '18px',
                flexShrink: 0
              }}>
                {stat.icon}
              </div>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div className="md-typescale-title-medium" style={{ 
                  color: 'var(--md-sys-color-on-surface)',
                  marginBottom: '2px'
                }}>
                  {stat.value}
                </div>
                <div className="md-typescale-body-small" style={{ 
                  color: 'var(--md-sys-color-on-surface-variant)'
                }}>
                  {stat.label}
                </div>
              </div>
            </div>
          ))}
        </div>
      </header>

      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: '1fr 400px', 
        gap: '24px',
        maxWidth: '1600px',
        margin: '0 auto'
      }}>
        {/* Transaction Processing */}
        <div className="md-elevated-card md-animate-slide-in-up">
          <h3 className="md-typescale-title-large" style={{
            color: 'var(--md-sys-color-on-surface)',
            marginBottom: '20px'
          }}>
            Transaction Processing
          </h3>

          {/* Tab Selector */}
          <div style={{ 
            display: 'flex', 
            gap: '8px', 
            marginBottom: '24px',
            padding: '4px',
            background: 'var(--md-sys-color-surface-container-highest)',
            borderRadius: 'var(--md-sys-shape-corner-large)'
          }}>
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className="md-ripple"
                style={{
                  flex: 1,
                  padding: '12px 16px',
                  background: activeTab === tab.id ? 'var(--md-sys-color-surface)' : 'transparent',
                  border: 'none',
                  borderRadius: 'var(--md-sys-shape-corner-medium)',
                  color: activeTab === tab.id ? 'var(--md-sys-color-on-surface)' : 'var(--md-sys-color-on-surface-variant)',
                  fontWeight: activeTab === tab.id ? '600' : '500',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '8px',
                  transition: 'all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard)',
                  boxShadow: activeTab === tab.id ? 'var(--md-sys-elevation-1)' : 'none'
                }}
              >
                <span style={{ fontSize: '20px' }}>{tab.icon}</span>
                <span className="md-typescale-label-large">{tab.name}</span>
              </button>
            ))}
          </div>

          {/* Message Display */}
          {message.text && (
            <div className="md-filled-card md-animate-scale-in" style={{
              padding: '12px 16px',
              marginBottom: '20px',
              background: message.type === 'success' 
                ? 'var(--md-sys-color-secondary-container)' 
                : 'var(--md-sys-color-error-container)',
              color: message.type === 'success' 
                ? 'var(--md-sys-color-on-secondary-container)' 
                : 'var(--md-sys-color-on-error-container)'
            }}>
              <div className="md-typescale-body-medium">
                {message.type === 'success' ? '✓ ' : '✗ '}
                {message.text}
              </div>
            </div>
          )}

          {/* Transaction Forms */}
          {activeTab === 'deposit' && (
            <TransactionForm
              type="Deposit"
              amount={depositAmount}
              setAmount={setDepositAmount}
              memberId={depositMemberId}
              setMemberId={setDepositMemberId}
              members={members}
              accountType={accountType}
              setAccountType={setAccountType}
              handleSubmit={handleTransactionSubmit}
              loading={loading}
            />
          )}

          {activeTab === 'withdrawal' && (
            <TransactionForm
              type="Withdrawal"
              amount={withdrawalAmount}
              setAmount={setWithdrawalAmount}
              memberId={withdrawalMemberId}
              setMemberId={setWithdrawalMemberId}
              members={members}
              accountType={accountType}
              setAccountType={setAccountType}
              handleSubmit={handleTransactionSubmit}
              loading={loading}
            />
          )}
        </div>

        {/* Sidebar */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
          {/* Recent Transactions */}
          <div className="md-elevated-card md-animate-slide-in-up" style={{ animationDelay: '100ms' }}>
            <h4 className="md-typescale-title-medium" style={{
              color: 'var(--md-sys-color-on-surface)',
              marginBottom: '16px'
            }}>
              📋 Recent Transactions
            </h4>
            <div style={{
              maxHeight: '400px',
              overflowY: 'auto',
              display: 'flex',
              flexDirection: 'column',
              gap: '8px'
            }}>
              {(transactions || []).length === 0 ? (
                <div style={{
                  padding: '40px 20px',
                  textAlign: 'center',
                  color: 'var(--md-sys-color-on-surface-variant)'
                }}>
                  <div style={{ fontSize: '48px', marginBottom: '12px' }}>📭</div>
                  <p className="md-typescale-body-medium">No transactions yet</p>
                </div>
              ) : (
                (transactions || []).slice(0, 10).map((transaction, index) => (
                  <div key={transaction.id || index} className="md-list-item" style={{
                    padding: '12px',
                    background: 'var(--md-sys-color-surface-container-low)',
                    borderRadius: 'var(--md-sys-shape-corner-medium)'
                  }}>
                    <div style={{ flex: 1 }}>
                      <div className="md-typescale-title-small" style={{
                        color: 'var(--md-sys-color-on-surface)',
                        marginBottom: '4px'
                      }}>
                        {transaction.type}
                      </div>
                      <div className="md-typescale-body-small" style={{
                        color: 'var(--md-sys-color-on-surface-variant)'
                      }}>
                        {new Date(transaction.timestamp).toLocaleString()}
                      </div>
                    </div>
                    <div className="md-typescale-title-small" style={{
                      fontWeight: '600',
                      color: transaction.amount >= 0 
                        ? 'var(--md-sys-color-secondary)' 
                        : 'var(--md-sys-color-error)'
                    }}>
                      {transaction.amount >= 0 ? '+' : ''}{formatCurrencyGHS(Math.abs(transaction.amount))}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Notifications */}
          <div className="md-elevated-card md-animate-slide-in-up" style={{ animationDelay: '200ms' }}>
            <h4 className="md-typescale-title-medium" style={{
              color: 'var(--md-sys-color-on-surface)',
              marginBottom: '16px'
            }}>
              ⚠️ Notifications
            </h4>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              {[
                { message: 'Cash drawer needs reconciliation', type: 'warning' },
                { message: '2 transactions pending manager approval', type: 'info' },
                { message: 'System maintenance at 10 PM', type: 'info' }
              ].map((notification, index) => (
                <div key={index} className="md-filled-card" style={{
                  padding: '12px',
                  background: notification.type === 'warning' 
                    ? 'var(--md-sys-color-tertiary-container)' 
                    : 'var(--md-sys-color-primary-container)',
                  color: notification.type === 'warning' 
                    ? 'var(--md-sys-color-on-tertiary-container)' 
                    : 'var(--md-sys-color-on-primary-container)'
                }}>
                  <p className="md-typescale-body-small">{notification.message}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default CashierDashboard;