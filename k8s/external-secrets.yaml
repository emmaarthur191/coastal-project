# =============================================================================
# Kubernetes External Secrets Configuration
# =============================================================================
# This file demonstrates how to use External Secrets Operator to securely
# manage secrets from external providers (AWS Secrets Manager, HashiCorp Vault, etc.)
#
# Prerequisites:
# 1. Install External Secrets Operator: https://external-secrets.io/latest/introduction/getting-started/
# 2. Configure a SecretStore for your provider
# 3. Store secrets in your external provider
#
# Usage: kubectl apply -f external-secrets.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# Option 1: AWS Secrets Manager SecretStore
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: banking-app
spec:
  provider:
    aws:
      service: SecretsManager
      region: eu-central-1  # Match your deployment region
      auth:
        # Use IAM Roles for Service Accounts (IRSA) - recommended
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
# -----------------------------------------------------------------------------
# Option 2: HashiCorp Vault SecretStore (Alternative)
# -----------------------------------------------------------------------------
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: vault-backend
#   namespace: banking-app
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com:8200"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "banking-app"

---
# -----------------------------------------------------------------------------
# ExternalSecret: Banking Application Secrets
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: banking-external-secret
  namespace: banking-app
  labels:
    app: banking-backend
spec:
  # How often to sync secrets (refresh interval)
  refreshInterval: 1h

  # Reference to the SecretStore
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  # The Kubernetes Secret that will be created/updated
  target:
    name: banking-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app: banking-backend
        annotations:
          managed-by: external-secrets

  # Map external secrets to Kubernetes secret keys
  data:
    # Django Secret Key
    - secretKey: SECRET_KEY
      remoteRef:
        key: coastal/prod/django
        property: secret_key

    # Database Connection String
    - secretKey: DATABASE_URL
      remoteRef:
        key: coastal/prod/database
        property: connection_string

    # Database Password (for backup jobs)
    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: coastal/prod/database
        property: password

    # Flower Monitoring Auth
    - secretKey: FLOWER_BASIC_AUTH
      remoteRef:
        key: coastal/prod/monitoring
        property: flower_auth

    # Sendexa SMS Gateway
    - secretKey: SENDEXA_API_KEY
      remoteRef:
        key: coastal/prod/sendexa
        property: api_key

    - secretKey: SENDEXA_API_SECRET
      remoteRef:
        key: coastal/prod/sendexa
        property: api_secret

    - secretKey: SENDEXA_AUTH_TOKEN
      remoteRef:
        key: coastal/prod/sendexa
        property: auth_token

    # Sentry Error Monitoring
    - secretKey: SENTRY_DSN
      remoteRef:
        key: coastal/prod/monitoring
        property: sentry_dsn

---
# -----------------------------------------------------------------------------
# Service Account for External Secrets (AWS IRSA)
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: banking-app
  annotations:
    # Replace with your AWS IAM role ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/CoastalExternalSecretsRole

---
# =============================================================================
# FALLBACK: Manual Secret Template (for development/testing only)
# =============================================================================
# If not using External Secrets, create secrets manually:
#
# kubectl create secret generic banking-secret \
#   --namespace=banking-app \
#   --from-literal=SECRET_KEY='your-production-secret-key' \
#   --from-literal=DATABASE_URL='postgres://user:pass@host:5432/db' \
#   --from-literal=DATABASE_PASSWORD='your-db-password' \
#   --from-literal=FLOWER_BASIC_AUTH='admin:secure-password'
#
# NEVER commit actual secret values to version control!
# =============================================================================
